<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ADMIN | Jadwal Canyoning</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --primary: #2563eb;
        --success: #16a34a;
        --danger: #dc2626;
        --bg-light: #f3f4f6;
        --card-bg: #ffffff;
        --text-main: #1f2937;
        --text-muted: #6b7280;
        --border: #e5e7eb;
    }

    body { 
        font-family: 'Inter', sans-serif; 
        margin: 0; 
        background-color: var(--bg-light); 
        color: var(--text-main); 
        padding-bottom: 80px; 
        -webkit-tap-highlight-color: transparent;
    }
    
    /* Sticky Header */
    .header-controls {
        background: var(--card-bg);
        padding: 15px;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border-bottom: 1px solid var(--border);
    }

    .app-title {
        font-size: 1.1rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 10px;
        color: var(--text-main);
    }

    select { 
        padding: 12px; 
        font-size: 16px; 
        border: 2px solid var(--border); 
        border-radius: 8px; 
        width: 100%; 
        background: #fff;
        font-family: inherit;
        color: var(--text-main);
        outline: none;
    }
    select:focus { border-color: var(--primary); }

    .container { max-width: 600px; margin: 0 auto; padding: 15px; }

    /* Accordion Style */
    .accordion-item { 
        background: var(--card-bg); 
        border-radius: 12px; 
        margin-bottom: 12px; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        overflow: hidden; 
        border: 1px solid var(--border);
    }
    
    .accordion-header { 
        padding: 16px; 
        cursor: pointer; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        background: var(--card-bg);
        transition: all 0.2s;
    }
    
    .accordion-header.active { 
        background: #eff6ff; 
        border-bottom: 1px solid #dbeafe; 
    }

    .date-box {
        display: flex;
        flex-direction: column;
    }
    .date-day { font-weight: 700; font-size: 1rem; color: var(--text-main); }
    
    .status-badge { 
        font-size: 0.75rem; 
        padding: 4px 10px; 
        border-radius: 20px; 
        font-weight: 600; 
        letter-spacing: 0.5px;
    }
    .status-normal { background: #f3f4f6; color: var(--text-muted); }
    .status-full { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; }

    .accordion-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: #fafafa; }

    /* --- MOBILE CARD VIEW --- */
    table { width: 100%; border-collapse: collapse; }
    
    @media (min-width: 601px) {
        th { background: #f9fafb; text-align: left; padding: 12px; font-size: 0.85rem; color: var(--text-muted); border-bottom: 1px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        .mobile-label { display: none; }
    }

    @media (max-width: 600px) {
        thead { display: none; }
        tr { 
            display: block; 
            margin: 15px; 
            background: white; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        td { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 8px 0; 
            border-bottom: 1px solid #f3f4f6; 
            font-size: 0.95rem;
        }
        td:last-child { border-bottom: none; }
        td::before {
            content: attr(data-label);
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-right: 15px;
            text-transform: uppercase;
        }
        .action-cell {
            display: block;
            margin-top: 10px;
            border-top: 1px dashed var(--border);
            padding-top: 10px;
            text-align: center;
        }
        .action-cell::before { display: none; }
    }

    .row-lunas { opacity: 0.6; background-color: #f9f9f9 !important; }
    .row-lunas td { text-decoration: line-through; color: var(--text-muted); }
    .row-lunas .btn-action { text-decoration: none !important; }

    .badge { padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 0.85em; }
    .badge-full { background: #fee2e2; color: #b91c1c; }
    .badge-dp { background: #ffedd5; color: #c2410c; }
    
    /* Summary Section - DEFAULT HIDDEN */
    #secretSection { display: none; } /* KUNCI: Disembunyikan disini */
    
    .summary-box { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-top: 4px solid var(--success); margin-bottom: 30px;}
    .summary-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .summary-row:last-child { border: none; font-weight: 800; font-size: 1.1em; margin-top: 10px; }
    .badge-pic { background: #dcfce7; color: #15803d; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; }

    .btn-action {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        transition: transform 0.1s;
    }
    .btn-action:active { transform: scale(0.98); }
    .btn-pay { background: var(--success); color: white; box-shadow: 0 2px 4px rgba(22, 163, 74, 0.3); }
    .btn-cancel { background: white; color: var(--danger); border: 2px solid var(--danger); }

    .secret-container { text-align: center; margin-top: 40px; padding: 20px; }
    .secret-input { 
        padding: 12px; 
        border: 2px solid var(--border); 
        border-radius: 8px; 
        text-align: center; 
        width: 150px; 
        transition: all 0.3s;
        font-size: 14px;
    }
    .secret-input:focus { border-color: var(--primary); width: 200px; outline: none; }
    
    #logoutBtn {
        background: var(--danger);
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        display: inline-block;
        margin-top: 15px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(220, 38, 38, 0.2);
    }

    #loading { margin-top: 50px; text-align: center; color: var(--text-muted); }
    .spinner { font-size: 2rem; animation: spin 1s infinite linear; display: inline-block; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

</style>
</head>
<body>

<div class="header-controls">
    <div class="app-title"> Jadwal Canyoning</div>
    <div class="container" style="padding:0; margin:0 auto;">
        <select id="sheetSelector"></select>
    </div>
</div>

<div id="loading">
    <div class="spinner">ðŸŒ€</div>
    <p>Sinkronisasi Data...</p>
</div>

<div id="app" style="display:none;">
    
    <div class="container" id="scheduleList"></div>

    <div class="container" id="secretSection">
        <div class="summary-box">
            <h3 style="margin:0 0 15px 0; color:var(--text-main); font-size:1.1rem;">ðŸ“Š Rekapitulasi PIC</h3>
            <div id="picSummary"></div>
        </div>
    </div>

    <div class="secret-container">
        <input type="password" id="adminKey" class="secret-input" placeholder="">
        <div id="logoutBtn" style="display:none;" onclick="logoutAdmin()">Keluar Admin</div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzcDMlGtcoO2yY1wFd-ZMTyk3hs-dOmlUhnKd-rryL5JYAQSx-R07wRiP-A6D3bPl6Shg/exec"; 
    const SECRET_KEY = "q"; 
    const ADMIN_STORAGE_KEY = "pacet_admin_session"; 
    const LUNAS_STORAGE_PREFIX = "status_lunas_"; 

    let CACHED_DATA = []; 
    let CURRENT_HEADERS = [];
    let IS_ADMIN = false;

    document.addEventListener("DOMContentLoaded", init);

    async function init() {
        const loading = document.getElementById('loading');
        const keyInput = document.getElementById('adminKey');
        
        // Auto Login Check
        if (localStorage.getItem(ADMIN_STORAGE_KEY) === 'true') {
            enableAdminMode(keyInput);
        }
        
        // Login Listener
        keyInput.addEventListener('input', function(e) {
            if (e.target.value === SECRET_KEY) {
                localStorage.setItem(ADMIN_STORAGE_KEY, 'true');
                enableAdminMode(e.target);
                
                // Render Ulang setelah login agar summary muncul
                renderSummary(CACHED_DATA);
                renderSchedule(CURRENT_HEADERS, CACHED_DATA);
                alert("âœ… Mode Admin Aktif");
            }
        });

        try {
            let response = await fetch(SCRIPT_URL);
            let sheets = await response.json();
            
            const now = new Date();
            const currentPeriod = new Intl.DateTimeFormat('id-ID', { month: 'long', year: 'numeric' }).format(now).toLowerCase();
            const select = document.getElementById('sheetSelector');
            let matchedGid = sheets[0].gid; 

            sheets.forEach(sheet => {
                let opt = document.createElement('option');
                opt.value = sheet.gid;
                opt.innerText = sheet.name;
                if (sheet.name.toLowerCase().includes(currentPeriod)) matchedGid = sheet.gid;
                select.appendChild(opt);
            });

            select.value = matchedGid;
            loading.style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            loadSheetData(matchedGid);
            select.addEventListener('change', (e) => loadSheetData(e.target.value));

        } catch (err) {
            loading.innerHTML = `<div style="color:red; padding:20px;">Gagal memuat data.<br>${err.message}</div>`;
        }
    }

    function enableAdminMode(inputElement) {
        IS_ADMIN = true;
        // Tampilkan Section Rekapitulasi
        document.getElementById('secretSection').style.display = 'block';
        // Tampilkan Tombol Logout
        document.getElementById('logoutBtn').style.display = 'inline-block';
        // Sembunyikan Input
        inputElement.style.display = 'none'; 
    }

    async function loadSheetData(gid) {
        const container = document.getElementById('scheduleList');
        container.innerHTML = "<p style='text-align:center; padding:20px; color:#888;'>Memuat data...</p>";

        try {
            let res = await fetch(`${SCRIPT_URL}?gid=${gid}`);
            let rawData = await res.json();

            if (!rawData || rawData.length < 2) {
                container.innerHTML = "<p style='text-align:center; padding:20px;'>Belum ada jadwal.</p>";
                CACHED_DATA = [];
                return;
            }

            CURRENT_HEADERS = rawData[0];
            CACHED_DATA = processData(rawData.slice(1));

            renderSchedule(CURRENT_HEADERS, CACHED_DATA);
            
            // HANYA RENDER SUMMARY JIKA ADMIN
            if(IS_ADMIN) {
                renderSummary(CACHED_DATA);
            }

        } catch (err) {
            container.innerHTML = "Gagal memuat data.";
        }
    }

    function processData(rows) {
        let result = [];
        let lastDate = null;
        rows.forEach(row => {
            let newRow = [...row];
            let date = newRow[0];
            if ((!date || date === "") && lastDate && newRow.slice(1).some(c => c)) {
                newRow[0] = lastDate;
            } else if (date) {
                lastDate = date;
            } else return;
            result.push(newRow);
        });
        return result;
    }

    function renderSchedule(headers, data) {
        let groups = {};
        data.forEach(row => {
            let d = row[0];
            if (!groups[d]) groups[d] = [];
            groups[d].push(row);
        });

        const container = document.getElementById('scheduleList');
        container.innerHTML = "";

        for (let date in groups) {
            let items = groups[date];
            let totalGuest = items.reduce((sum, r) => sum + (parseInt(r[1]) || 0), 0);
            let isFull = totalGuest >= 17;

            let itemDiv = document.createElement('div');
            itemDiv.className = 'accordion-item';

            let headerHTML = `
                <div class="accordion-header">
                    <div class="date-box">
                        <span class="date-day">${date}</span>
                    </div>
                    <span class="status-badge ${isFull ? 'status-full' : 'status-normal'}">
                        ${isFull ? 'FULL SLOT' : `${totalGuest} Tamu`}
                    </span>
                </div>
                <div class="accordion-body">
                    <table>
                        <thead>
                            <tr>`;
            
            for(let i=1; i<headers.length; i++) headerHTML += `<th>${headers[i]}</th>`;
            if (IS_ADMIN) headerHTML += `<th style="text-align:center;">Admin</th>`;
            
            headerHTML += `</tr></thead><tbody>`;
            
            let bodyContent = "";

            items.forEach((row, index) => {
                let rowID = btoa(date + "_" + index + "_" + (row[2] || "x")); 
                let isLunas = localStorage.getItem(LUNAS_STORAGE_PREFIX + rowID) === 'true';
                let rowClass = (isLunas && IS_ADMIN) ? 'class="row-lunas"' : '';

                bodyContent += `<tr ${rowClass}>`;
                
                for(let i=1; i<headers.length; i++) {
                    let text = row[i] || "";
                    let headerLabel = headers[i]; 
                    let cellContent = text;
                    let lowerText = text.toString().toLowerCase();

                    if(lowerText.includes('full')) cellContent = `<span class="badge badge-full">${text}</span>`;
                    else if(lowerText.includes('dp') || lowerText.includes('lunas')) cellContent = `<span class="badge badge-dp">${text}</span>`;
                    
                    bodyContent += `<td data-label="${headerLabel}">${cellContent}</td>`;
                }

                if (IS_ADMIN) {
                    let btnHTML = isLunas 
                        ? `<button class="btn-action btn-cancel" onclick="toggleStatus('${rowID}', false)">Batal Lunas</button>`
                        : `<button class="btn-action btn-pay" onclick="toggleStatus('${rowID}', true)">Tandai Lunas</button>`;
                    
                    bodyContent += `<td class="action-cell" data-label="Aksi">${btnHTML}</td>`;
                }

                bodyContent += `</tr>`;
            });

            headerHTML += bodyContent + `</tbody></table></div>`;
            itemDiv.innerHTML = headerHTML;
            container.appendChild(itemDiv);

            itemDiv.querySelector('.accordion-header').addEventListener('click', function() {
                this.classList.toggle('active');
                let body = this.nextElementSibling;
                if (body.style.maxHeight) body.style.maxHeight = null;
                else body.style.maxHeight = body.scrollHeight + "px";
            });
        }
    }

    window.toggleStatus = function(rowID, setLunas) {
        if (setLunas) {
            if (confirm("Tandai tamu ini LUNAS?")) {
                localStorage.setItem(LUNAS_STORAGE_PREFIX + rowID, 'true');
                renderSchedule(CURRENT_HEADERS, CACHED_DATA); 
            }
        } else {
            if (confirm("Batalkan status Lunas?")) {
                localStorage.removeItem(LUNAS_STORAGE_PREFIX + rowID);
                renderSchedule(CURRENT_HEADERS, CACHED_DATA); 
            }
        }
    };

    window.logoutAdmin = function() {
        if(confirm("Keluar dari Admin?")) {
            localStorage.removeItem(ADMIN_STORAGE_KEY);
            location.reload(); 
        }
    }

    function renderSummary(data) {
        let picMap = {};
        let grandTotal = 0;
        data.forEach(row => {
            let qty = parseInt(row[1]) || 0; 
            let pic = row[3]; 
            if (qty > 0 && pic && pic.trim() !== '-' && pic.trim() !== '') {
                let name = pic.trim().toLowerCase().replace(/\b\w/g, c => c.toUpperCase()); 
                picMap[name] = (picMap[name] || 0) + qty;
                grandTotal += qty;
            }
        });
        let sorted = Object.entries(picMap).sort((a,b) => b[1] - a[1]);
        let html = "";
        if (sorted.length === 0) html = "<p style='text-align:center; color:#999'>Data kosong</p>";
        else {
            sorted.forEach(([name, count]) => {
                html += `<div class="summary-row"><span>${name}</span><span class="badge-pic">${count}</span></div>`;
            });
            html += `<div class="summary-row" style="margin-top:15px; border-top:2px solid #eee; padding-top:15px"><span>TOTAL</span><span>${grandTotal}</span></div>`;
        }
        document.getElementById('picSummary').innerHTML = html;
    }
</script>

</body>
</html>
