<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ADMIN | Jadwal Canyoning</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
    :root {
        --primary: #2563eb;
        --success: #22c55e;
        --danger: #ef4444;
        --bg-body: #f8fafc;
        --text-dark: #0f172a;
        --text-gray: #64748b;
        --border-color: #e2e8f0;
    }

    body { 
        font-family: 'Inter', sans-serif; 
        margin: 0; 
        background-color: var(--bg-body); 
        color: var(--text-dark); 
        padding-bottom: 80px; 
        -webkit-tap-highlight-color: transparent;
    }
    
    /* Sticky Header Clean */
    .header-controls {
        background: #fff;
        padding: 15px 20px;
        position: sticky;
        top: 0;
        z-index: 100;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
    }

    .app-title { font-size: 1rem; font-weight: 600; white-space: nowrap; }

    select { 
        padding: 8px 12px; 
        font-size: 14px; 
        border: 1px solid var(--border-color); 
        border-radius: 6px; 
        background: #f1f5f9;
        color: var(--text-dark);
        outline: none;
        width: 100%;
        max-width: 200px;
    }

    .container { max-width: 600px; margin: 0 auto; padding: 15px; }

    /* Accordion Minimalis */
    .accordion-item { 
        background: #fff; 
        border-radius: 8px; 
        margin-bottom: 10px; 
        border: 1px solid var(--border-color);
        overflow: hidden;
    }
    
    .accordion-header { 
        padding: 15px; 
        cursor: pointer; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        background: #fff;
    }
    
    .accordion-header.active { background: #f8fafc; }
    .date-day { font-weight: 600; font-size: 0.95rem; }
    
    .status-text { 
        font-size: 0.8rem; 
        font-weight: 500;
        color: var(--text-gray);
    }
    .status-text.full { color: var(--danger); font-weight: 600; }

    .accordion-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }

    /* --- TABEL SUPER SIMPEL (Mobile List View) --- */
    table { width: 100%; border-collapse: collapse; }
    
    /* Desktop View */
    @media (min-width: 601px) {
        th { text-align: left; padding: 12px; font-size: 0.85rem; color: var(--text-gray); border-bottom: 1px solid var(--border-color); background: #f8fafc; }
        td { padding: 12px; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
    }

    /* Mobile View - Clean List */
    @media (max-width: 600px) {
        thead { display: none; }
        
        tr { 
            display: block; 
            border-bottom: 1px solid var(--border-color); 
            padding: 12px 15px;
        }
        tr:last-child { border-bottom: none; }

        td { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            padding: 4px 0; 
            font-size: 0.95rem;
            border: none;
        }

        /* Label (Kiri) */
        td::before {
            content: attr(data-label);
            font-size: 0.8rem;
            color: #94a3b8; /* Abu-abu muda */
            margin-right: 15px;
            font-weight: 500;
            min-width: 80px; 
        }
        
        /* Value (Kanan) */
        td > span, td > div {
            text-align: right;
            flex: 1;
            color: var(--text-dark);
        }

        /* Action Cell khusus */
        .action-cell {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
            display: block;
        }
        .action-cell::before { display: none; }
    }

    /* Efek Coretan Lunas */
    .row-lunas td { opacity: 0.5; text-decoration: line-through; }
    .row-lunas .btn-action { opacity: 1; text-decoration: none; } 

    /* Badges Minimalis */
    .badge { padding: 2px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600; display: inline-block;}
    .badge-full { background: #fee2e2; color: #dc2626; }
    .badge-dp { background: #ffedd5; color: #c2410c; }
    
    /* Admin Section */
    #secretSection { display: none; }
    
    .summary-box { 
        background: #fff; 
        padding: 20px; 
        border-radius: 8px; 
        border: 1px solid var(--border-color);
        margin-bottom: 30px;
    }
    .summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
    .summary-row:last-child { border: none; font-weight: 600; margin-top: 5px; font-size: 1rem; }

    /* Tombol Admin Flat */
    .btn-action {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.85rem;
        border: none;
        cursor: pointer;
    }
    .btn-pay { background: #dcfce7; color: #166534; } 
    .btn-cancel { background: #fee2e2; color: #991b1b; } 

    /* Login Area */
    .secret-container { text-align: center; margin-top: 30px; padding: 20px; }
    .secret-input { 
        padding: 10px; 
        border: 1px solid var(--border-color); 
        border-radius: 6px; 
        text-align: center; 
        font-size: 14px;
        background: #fff;
    }
    
    #logoutBtn {
        color: var(--danger);
        font-size: 0.85rem;
        margin-top: 15px;
        cursor: pointer;
        text-decoration: underline;
    }

    #loading { margin-top: 50px; text-align: center; color: var(--text-gray); font-size: 0.9rem; }

</style>
</head>
<body>

<div class="header-controls">
    <div class="app-title">Pilih Bulan</div>
    <select id="sheetSelector"></select>
</div>

<div id="loading">âŸ³ Memuat data...</div>

<div id="app" style="display:none;">
    
    <div class="container" id="scheduleList"></div>

    <div class="container" id="secretSection">
        <div class="summary-box">
            <h3 style="margin:0 0 15px 0; font-size:1rem;">ðŸ“Š Rekap Admin</h3>
            <div id="picSummary"></div>
        </div>
    </div>

    <div class="secret-container">
        <input type="password" id="adminKey" class="secret-input" placeholder="">
        <div id="logoutBtn" style="display:none;" onclick="logoutAdmin()">Logout</div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzcDMlGtcoO2yY1wFd-ZMTyk3hs-dOmlUhnKd-rryL5JYAQSx-R07wRiP-A6D3bPl6Shg/exec"; 
    const SECRET_KEY = "q"; 
    const ADMIN_STORAGE_KEY = "pacet_admin_session"; 
    const LUNAS_STORAGE_PREFIX = "status_lunas_"; 

    let CACHED_DATA = []; 
    let CURRENT_HEADERS = [];
    let IS_ADMIN = false;

    document.addEventListener("DOMContentLoaded", init);

    async function init() {
        const loading = document.getElementById('loading');
        const keyInput = document.getElementById('adminKey');
        
        if (localStorage.getItem(ADMIN_STORAGE_KEY) === 'true') {
            enableAdminMode(keyInput);
        }
        
        keyInput.addEventListener('input', function(e) {
            if (e.target.value === SECRET_KEY) {
                localStorage.setItem(ADMIN_STORAGE_KEY, 'true');
                enableAdminMode(e.target);
                renderSummary(CACHED_DATA);
                renderSchedule(CURRENT_HEADERS, CACHED_DATA);
            }
        });

        try {
            let response = await fetch(SCRIPT_URL);
            let sheets = await response.json();
            
            const now = new Date();
            const currentPeriod = new Intl.DateTimeFormat('id-ID', { month: 'long', year: 'numeric' }).format(now).toLowerCase();
            const select = document.getElementById('sheetSelector');
            let matchedGid = sheets[0].gid; 

            sheets.forEach(sheet => {
                let opt = document.createElement('option');
                opt.value = sheet.gid;
                opt.innerText = sheet.name;
                if (sheet.name.toLowerCase().includes(currentPeriod)) matchedGid = sheet.gid;
                select.appendChild(opt);
            });

            select.value = matchedGid;
            loading.style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            loadSheetData(matchedGid);
            select.addEventListener('change', (e) => loadSheetData(e.target.value));

        } catch (err) {
            loading.innerHTML = "Gagal memuat data.";
        }
    }

    function enableAdminMode(inputElement) {
        IS_ADMIN = true;
        document.getElementById('secretSection').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'inline-block';
        inputElement.style.display = 'none'; 
    }

    async function loadSheetData(gid) {
        const container = document.getElementById('scheduleList');
        container.innerHTML = "<p style='text-align:center; padding:20px; color:#ccc;'>...</p>";

        try {
            let res = await fetch(`${SCRIPT_URL}?gid=${gid}`);
            let rawData = await res.json();

            if (!rawData || rawData.length < 2) {
                container.innerHTML = "<p style='text-align:center; padding:20px;'>KOSONG</p>";
                CACHED_DATA = [];
                return;
            }

            CURRENT_HEADERS = rawData[0];
            CACHED_DATA = processData(rawData.slice(1));

            renderSchedule(CURRENT_HEADERS, CACHED_DATA);
            if(IS_ADMIN) renderSummary(CACHED_DATA);

        } catch (err) {
            container.innerHTML = "Error.";
        }
    }

    function processData(rows) {
        let result = [];
        let lastDate = null;
        rows.forEach(row => {
            let newRow = [...row];
            let date = newRow[0];
            if ((!date || date === "") && lastDate && newRow.slice(1).some(c => c)) {
                newRow[0] = lastDate;
            } else if (date) {
                lastDate = date;
            } else return;
            result.push(newRow);
        });
        return result;
    }

    function renderSchedule(headers, data) {
        let groups = {};
        data.forEach(row => {
            let d = row[0];
            if (!groups[d]) groups[d] = [];
            groups[d].push(row);
        });

        const container = document.getElementById('scheduleList');
        container.innerHTML = "";

        for (let date in groups) {
            let items = groups[date];
            let totalGuest = items.reduce((sum, r) => sum + (parseInt(r[1]) || 0), 0);
            let isFull = totalGuest >= 17;

            let itemDiv = document.createElement('div');
            itemDiv.className = 'accordion-item';

            let headerHTML = `
                <div class="accordion-header">
                    <span class="date-day">${date}</span>
                    <span class="status-text ${isFull ? 'full' : ''}">
                        ${isFull ? 'FULL' : `${totalGuest} Tamu`}
                    </span>
                </div>
                <div class="accordion-body">
                    <table>
                        <thead><tr>`;
            
            // --- LOOPING HEADER ---
            for(let i=1; i<headers.length; i++) {
                let hName = headers[i].toLowerCase();
                // HANYA HAPUS jika ada kata 'fix'
                // Kata 'jumlah' saja akan tetap muncul
                if (hName.includes('fix')) continue;

                headerHTML += `<th>${headers[i]}</th>`;
            }

            if (IS_ADMIN) headerHTML += `<th>Aksi</th>`;
            
            headerHTML += `</tr></thead><tbody>`;
            
            let bodyContent = "";

            items.forEach((row, index) => {
                let rowID = btoa(date + "_" + index + "_" + (row[2] || "x")); 
                let isLunas = localStorage.getItem(LUNAS_STORAGE_PREFIX + rowID) === 'true';
                let rowClass = (isLunas && IS_ADMIN) ? 'class="row-lunas"' : '';

                bodyContent += `<tr ${rowClass}>`;
                
                // --- LOOPING ISI DATA ---
                for(let i=1; i<headers.length; i++) {
                    let hName = headers[i].toLowerCase();
                    // SAMA: HANYA HAPUS jika ada kata 'fix'
                    if (hName.includes('fix')) continue;

                    let text = row[i] || "";
                    let headerLabel = headers[i]; 
                    let cellContent = text;
                    let lowerText = text.toString().toLowerCase();

                    if(lowerText.includes('full')) cellContent = `<span class="badge badge-full">${text}</span>`;
                    else if(lowerText.includes('dp') || lowerText.includes('lunas')) cellContent = `<span class="badge badge-dp">${text}</span>`;
                    
                    bodyContent += `<td data-label="${headerLabel}"><span>${cellContent}</span></td>`;
                }

                if (IS_ADMIN) {
                    let btnHTML = isLunas 
                        ? `<button class="btn-action btn-cancel" onclick="toggleStatus('${rowID}', false)">Batal Lunas</button>`
                        : `<button class="btn-action btn-pay" onclick="toggleStatus('${rowID}', true)">Tandai Lunas</button>`;
                    
                    bodyContent += `<td class="action-cell">${btnHTML}</td>`;
                }

                bodyContent += `</tr>`;
            });

            headerHTML += bodyContent + `</tbody></table></div>`;
            itemDiv.innerHTML = headerHTML;
            container.appendChild(itemDiv);

            itemDiv.querySelector('.accordion-header').addEventListener('click', function() {
                this.classList.toggle('active');
                let body = this.nextElementSibling;
                if (body.style.maxHeight) body.style.maxHeight = null;
                else body.style.maxHeight = body.scrollHeight + "px";
            });
        }
    }

    window.toggleStatus = function(rowID, setLunas) {
        if (setLunas) {
            if (confirm("Lunas?")) {
                localStorage.setItem(LUNAS_STORAGE_PREFIX + rowID, 'true');
                renderSchedule(CURRENT_HEADERS, CACHED_DATA); 
            }
        } else {
            if (confirm("Batal Lunas?")) {
                localStorage.removeItem(LUNAS_STORAGE_PREFIX + rowID);
                renderSchedule(CURRENT_HEADERS, CACHED_DATA); 
            }
        }
    };

    window.logoutAdmin = function() {
        if(confirm("Keluar Admin?")) {
            localStorage.removeItem(ADMIN_STORAGE_KEY);
            location.reload(); 
        }
    }

    function renderSummary(data) {
        let picMap = {};
        let grandTotal = 0;
        data.forEach(row => {
            let qty = parseInt(row[1]) || 0; 
            let pic = row[3]; 
            if (qty > 0 && pic && pic.trim() !== '-' && pic.trim() !== '') {
                let name = pic.trim().toLowerCase().replace(/\b\w/g, c => c.toUpperCase()); 
                picMap[name] = (picMap[name] || 0) + qty;
                grandTotal += qty;
            }
        });
        let sorted = Object.entries(picMap).sort((a,b) => b[1] - a[1]);
        let html = "";
        if (sorted.length === 0) html = "<p style='text-align:center; color:#ccc'>Kosong</p>";
        else {
            sorted.forEach(([name, count]) => {
                html += `<div class="summary-row"><span>${name}</span><span>${count}</span></div>`;
            });
            html += `<div class="summary-row" style="margin-top:10px; border-top:1px solid #eee; padding-top:10px"><span>TOTAL</span><span>${grandTotal}</span></div>`;
        }
        document.getElementById('picSummary').innerHTML = html;
    }
</script>

</body>
</html>
